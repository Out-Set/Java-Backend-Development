package com.example.demo;

import okhttp3.MediaType;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.Map;

import okhttp3.*;
import org.springframework.stereotype.Component;

import static com.example.demo.StaticConst.AUTH_TOKEN;

@Component
public class FileUploadService {
    public int upload(SwaggerModel swaggerModel,Map<String, File> fileNameWithFile) throws IOException {

        OkHttpClient client = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("text/plain");

        MultipartBody.Builder requestBodyBuilder = new MultipartBody.Builder().setType(MultipartBody.FORM);

        for (Map.Entry<String, File> entry : fileNameWithFile.entrySet()) {
            String fileName = entry.getKey();
            File file = entry.getValue();
            requestBodyBuilder.addFormDataPart("file_new", fileName,
                    RequestBody.create(MediaType.parse("application/octet-stream"), file));
        }

        requestBodyBuilder.addFormDataPart("action_name", swaggerModel.getDocName());
        requestBodyBuilder.addFormDataPart("action", "1");

        RequestBody requestBody = requestBodyBuilder.build();

        Request request = new Request.Builder()
                .url("http://194.233.84.104:5090/api/v4/documents/3/files/")
                .method("POST", requestBody)
                .addHeader("Authorization", AUTH_TOKEN)
                .build();
        Response response = client.newCall(request).execute();
        return response.code();
    }

    public String delete(List<String> fileNames, String UPLOAD_DIR) throws IOException {
        try {
            for(String fileName: fileNames){
                Path filePathToDelete = Paths.get(UPLOAD_DIR, fileName);
                Files.delete(filePathToDelete);
            }
            return "Files deleted successfully";
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
        return "Error deleting file";
    }
}
